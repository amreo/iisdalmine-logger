#/bin/sh

# funzione help
function help {
	echo "iisdalmine-configure può essere richiamato con queste opzioni: "
	echo " -u --username imposta l'username da argomenti. Richiede un valore 
	 -s --password imposta la password da opzioni. Richiede un valore
	 -i --firewall-ip imposta l'indirizzo ip del firewall da opzioni. Richiede un valore
	 -p --firewall-port imposta la porta da opzioni. Richiede un valore
	 -v --verbose mosta un log dettagliato di iisdalmine-configure
	 -c --check fa il controllo sull'indirizzo ip e porta del firewall
	 -h --help mostra l'help
	 --show-password mostra la password sullo stdout "
}

# verifica se getopt è quello vecchio o nuovo
getopt --test > /dev/null
if [[ $? -ne 4 ]]; then 
    echo "La versione di getopt è cosi vecchia. Aggiorna tutto!.`getopt --test`"
    exit 1
fi

# -u --username imposta l'username da argomenti. Richiede un valore
# -s --password imposta la password da opzioni. Richiede un valore
# -i --firewall-ip imposta l'indirizzo ip del firewall da opzioni. Richiede un valore
# -p --firewall-port imposta la porta da opzioni. Richiede un valore
# -v --verbose mosta un log dettagliato di iisdalmine-configure
# -c --check fa il controllo sull'indirizzo ip e porta del firewall
# -h --help mostra l'help
# --show-password mostra la password sullo stdout
SHORT=u:s:i:p:vch
LONG=username:,password:,firewall-ip:,firewall-port:,verbose,show-password,check,help
show_password=s

# Esegue lo parsing dello opzioni
PARSED=`getopt --options $SHORT --longoptions $LONG --name "$0" -- "$@"`

# Controlla l'uscita di getopt per errori
if [ $? -ne 0 ]; then
	echo "Errore nel parsing delle opzioni: $?"	
	exit 1
fi
eval set -- "$PARSED"

# Imposta le variabili interessate fino a -- 
while true; do
    case "$1" in
        -u|--username)
            username="$2"
            shift 2
            ;;
        -s|--password)
            password="$2"
            shift 2
            ;;
        -i|--firewall-ip)
            firewall_ip="$2"
            shift 2
            ;;
        -p|--firewall-port)
			firewall_port="$2"     
			shift 2
            ;;
		-v|--verbose)
			verbose=yes
            shift 1
            ;;
		-c|--check)
			check=yes
            shift 1
            ;;
		--show-password)
			show_password=
            shift 1
            ;;			 
		-h|--help)
			help
			exit 0
			;;
		--)
            shift
            break
            ;;
        *)
            echo "Errore nelle opzioni"
            exit 1
            ;;
    esac
done

if [ -n "$verbose" ]; then
	echo "\$username=$username"
	echo "\$password=$password"
	echo "\$firewall_ip=$firewall_ip"
	echo "\$firewall_port=$firewall_port"
	echo "\$show_password=$show_password"
	echo "\$check=$check"
fi

# Imposta $username dalle opzioni o dal file ~/.iisdalmine/username.txt 
if [ -n "$username" ]; then # username definito prima (da opzioni)
	sleep 0
elif [ -f ~/.iisdalmine/username.txt ]; then # username non definito, carica l'username da file, solo per mostrarlo all'input
	username=`cat ~/.iisdalmine/username.txt`
	ask_username="true"
fi

# Imposta $password dalle opzioni o dal file ~/.iisdalmine/password.txt 
if [ -n "$password" ]; then # password definito prima (da opzioni)
	sleep 0
elif [ -f ~/.iisdalmine/password.txt ]; then # password non definito, carica password da file, solo per mostrarlo all'input
	password=`cat ~/.iisdalmine/password.txt`
	ask_password="true"
fi

# Imposta $firewall_ip dalle opzioni o dal file ~/.iisdalmine/firewall-ip.txt 
if [ -n "$firewall_ip" ]; then # firewall_ip definito prima (da opzioni)
	sleep 0
elif [ -f ~/.iisdalmine/firewall-ip.txt ]; then # firewall-ip non definito, carica firewall-ip da file, solo per mostrarlo all'input
	firewall_ip=`cat ~/.iisdalmine/firewall-ip.txt`
	firewall_ip="true"
fi

# Imposta $firewall_port dalle opzioni o dal file ~/.iisdalmine/firewall-port.txt 
if [ -n "$firewall_port" ]; then # firewall_port definito prima (da opzioni)
	sleep 0
elif [ -f ~/.iisdalmine/firewall-port.txt ]; then # firewall-port non definito, carica firewall-port da file, solo per mostrarlo all'input
	firewall_port=`cat ~/.iisdalmine/firewall-port.txt`
	firewall_port="true"
fi

if [ -n "$verbose" ]; then
	echo "\$username=$username"
	echo "\$password=$password"
	echo "\$firewall_ip=$firewall_ip"
	echo "\$firewall_port=$firewall_port"
fi

# chiede l'username
if [ -n "$username_option" ]; then
	read -p "username($username): " username_input
else
	read -p "username: " username_input
fi 

# chiede password
if [ -n "$password_option" ]; then
	sleep 0
elif [ ${#password} -ne 0 ]; then
	if [ -n "$show_password" ]; then
		read -sp "password(****): " password_input
		echo # Va a capo
	else
		read -p "password($password): " password_input
	fi
else
	read -${show_password}p "password: " password_input
	echo # Va a capo
fi

# chiede l'indirizzo ip del fw
if [ -n "$firewall_ip_option" ]; then
	sleep 0
elif [ ${#firewall_ip} -ne 0 ]; then
	read -p "firewall-ip($firewall_ip): " firewall_ip_input
else
	read -p "firewall-ip: " firewall_ip_input
fi

# chiede la porta del webserver del fw
if [ -n "$firewall_port_option" ]; then
	sleep 0
elif [ ${#firewall_port} -ne 0 ]; then
	read -p "firewall-port($firewall_port): " firewall_port_input
else
	read -p "firewall-port: " firewall_port_input
fi

if [ -n "$verbose" ]; then
	echo "\$username_input=$username_input"
	echo "\$password_input=$password_input"
	echo "\$firewall_ip_input=$firewall_ip_input"
	echo "\$firewall_port_input=$firewall_port_input"
fi

# crea la directory .iisdalmine se non esiste
if ! [ -d ~/.iisdalmine ]; then
	mkdir ~/.iisdalmine
	if [ -n "$verbose" ]; then
		echo "Creata dir ~/.iisdalmine"
	fi
fi

# scrive l'username nel file se è stata impostata da opzioni o input
if [ -n "$username_option" ]; then
	echo $username_option > ~/.iisdalmine/username.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$username_option in ~/.iisdalmine/username.txt"
	fi
elif [ -n "$username_input" ]; then
	echo $username_input > ~/.iisdalmine/username.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$username_input in ~/.iisdalmine/username.txt"
	fi
elif ! [ -f ~/.iisdalmine/username.txt ]; then
	touch ~/.iisdalmine/username.txt
	if [ -n "$verbose" ]; then
		echo "Creato ~/.iisdalmine/username.txt"
	fi
fi

# scrive la pasword nel file se è stata impostata da opzioni o input
if [ -n "$password_option" ]; then
	echo $password_option > ~/.iisdalmine/password.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$password_option in ~/.iisdalmine/password.txt"
	fi
elif [ -n "$password_input" ]; then
	echo $password_input > ~/.iisdalmine/password.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$password_input in ~/.iisdalmine/password.txt"
	fi
elif ! [ -f ~/.iisdalmine/password.txt ]; then
	touch ~/.iisdalmine/password.txt
	if [ -n "$verbose" ]; then
		echo "Creato ~/.iisdalmine/password.txt"
	fi
fi

# scrive l'ip del fw nel file se è stata impostata da opzioni o input
if [ -n "$firewall_ip_option" ]; then
	echo $firewall_ip_option > ~/.iisdalmine/firewall-ip.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$firewall_ip_option in ~/.iisdalmine/firewall-ip.txt"
	fi
elif [ -n "$firewall_ip_input" ]; then
	echo $firewall_ip_input > ~/.iisdalmine/firewall-ip.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$firewall_ip_input in ~/.iisdalmine/firewall-ip.txt"
	fi
elif ! [ -f ~/.iisdalmine/firewall-ip.txt ]; then
	echo "172.22.20.254" > ~/.iisdalmine/firewall-ip.txt
	if [ -n "$verbose" ]; then
		echo "Creato ~/.iisdalmine/firewall-ip.txt con 172.22.20.254"
	fi
fi

# scrive la porta del webserver del fw nel file se è stata impostata da opzioni o input
if [ -n "$firewall_port_option" ]; then
	echo $firewall_port_option > ~/.iisdalmine/firewall-port.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$firewall_port_option in ~/.iisdalmine/firewall-port.txt"
	fi
elif [ -n "$firewall_port_input" ]; then
	echo $firewall_port_input > ~/.iisdalmine/firewall-port.txt	
	if [ -n "$verbose" ]; then
		echo "Scritto \$firewall_port_input in ~/.iisdalmine/firewall-port.txt"
	fi
elif ! [ -f ~/.iisdalmine/firewall-port.txt ]; then
	echo "4100" > ~/.iisdalmine/firewall-port.txt
	if [ -n "$verbose" ]; then
		echo "Creato ~/.iisdalmine/firewall-port.txt con 4100"
	fi
fi
